<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Tugbo — Year & Opacity Sliders (with Year Dots)</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        html,
        body,
        #map {
            height: 100%;
            margin: 0
        }

        .panel {
            position: absolute;
            top: 12px;
            left: 12px;
            z-index: 2;
            background: #fff;
            color: #1f2a33;
            border: 1px solid #cfd8dc;
            border-radius: 14px;
            box-shadow: 0 6px 22px rgba(0, 0, 0, .18);
            padding: 12px 14px;
            width: 340px;
            font: 14px/1.35 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
        }

        .panel h3 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 700
        }

        .legend {
            margin: 6px 0 8px
        }

        .legend .row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0
        }

        .legend .sw {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, .24)
        }

        .divider {
            margin: 10px 0;
            border: 0;
            border-top: 1px dashed #cfd8dc
        }

        .slider-group {
            margin: 8px 0 2px
        }

        .slider-label {
            font-weight: 700;
            margin: 0 0 6px
        }

        .slider-row {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px
        }

        .slider-row input[type=range] {
            width: 100%
        }

        /* Year dots under the slider */
        .year-dots {
            position: relative;
            height: 18px;
            margin-top: 6px;
        }

        .year-dot {
            position: absolute;
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #cfd8dc;
            border: 2px solid #fff;
            box-shadow: 0 0 0 1px rgba(0, 0, 0, .15);
            transform: translateX(-50%);
            cursor: pointer;
        }

        .year-dot:hover {
            box-shadow: 0 0 0 2px rgba(30, 136, 229, .25)
        }

        .year-dot.active {
            background: #1e88e5
        }

        .year-dot:focus {
            outline: 2px solid #1e88e5;
            outline-offset: 2px
        }

        .year-dot-label {
            position: absolute;
            top: 16px;
            transform: translateX(-50%);
            font-size: 11px;
            color: #607d8b;
            user-select: none;
            pointer-events: none;
        }

        .note {
            font-size: 12px;
            color: #607d8b;
            margin-top: 8px;
            white-space: pre-line
        }

        .popup {
            font: 13px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif
        }

        .popup .h {
            font-weight: 700;
            margin: 0 0 6px
        }

        .popup .kv {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2px 8px
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 999px;
            font-weight: 700
        }

        /* Warm palette (yellow→red) */
        .b-low {
            background: hsl(51, 98%, 49%);
            color: #222
        }

        .b-mod {
            background: hsl(39, 88%, 54%);
            color: #222
        }

        .b-high {
            background: hsl(23, 93%, 52%);
            color: #fff
        }

        .b-vhigh {
            background: hsl(8, 92%, 48%);
            color: #fff
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div class="panel">
        <h3>Flood Hazard (S1)</h3>

        <div class="legend">
            <div class="row"><span class="sw" style="background:hsl(51,98%,49%)"></span><span>Low</span></div>
            <div class="row"><span class="sw" style="background:hsl(39,88%,54%)"></span><span>Moderate</span></div>
            <div class="row"><span class="sw" style="background:hsl(23,93%,52%)"></span><span>High</span></div>
            <div class="row"><span class="sw" style="background:hsl(8,92%,48%)"></span><span>Very High</span></div>
        </div>

        <hr class="divider" />

        <!-- Year slider -->
        <div class="slider-group">
            <div class="slider-label">Flood Magnitude (annual)</div>
            <div class="row" style="margin:0 0 6px">Year: <span id="yearLabel">—</span></div>
            <div class="slider-row">
                <input id="year" type="range" min="2021" max="2025" step="1" value="2025" />
                <span id="yearVal">2025</span>
            </div>
            <!-- Dots get generated here -->
            <div class="year-dots" id="yearDots"></div>
        </div>

        <hr class="divider" />

        <!-- Opacity slider -->
        <div class="slider-group">
            <div class="slider-label">Opacity</div>
            <div class="slider-row">
                <input id="op" type="range" min="10" max="100" value="85" />
                <span id="opv">85%</span>
            </div>
        </div>

        <div class="note" id="status">Looking for layers…</div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.1/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1Ijoia3lhaGFuenp6IiwiYSI6ImNtZGR2YmpqMDA4enIya29zY21nY3hxMjQifQ.U3RNv0EJn1yPHwF41JZALA';
        const STYLE_URL = 'mapbox://styles/kyahanzzz/cmgg9f4h500ij01s69cewg1dd';
        const YEARS = [2021, 2022, 2023, 2024, 2025];
        let currentOpacity = 0.85;
        let selectedYear = 2025;

        const map = new mapboxgl.Map({
            container: 'map',
            style: STYLE_URL,
            center: [123.639, 12.349],
            zoom: 15
        });
        map.addControl(new mapboxgl.NavigationControl({ visualizePitch: true }), 'top-right');
        map.addControl(new mapboxgl.ScaleControl({ unit: 'metric' }), 'bottom-right');

        // UI els
        const status = document.getElementById('status');
        const yearSlider = document.getElementById('year');
        const yearVal = document.getElementById('yearVal');
        const yearLabel = document.getElementById('yearLabel');
        const yearDots = document.getElementById('yearDots');
        const opSlider = document.getElementById('op');
        const opVal = document.getElementById('opv');

        // Helpers
        function opacityPropForType(type) {
            return {
                'fill': 'fill-opacity', 'line': 'line-opacity', 'circle': 'circle-opacity',
                'symbol': 'icon-opacity', 'raster': 'raster-opacity', 'heatmap': 'heatmap-opacity',
                'fill-extrusion': 'fill-extrusion-opacity', 'background': 'background-opacity'
            }[type] || null;
        }
        function setLayerOpacity(id, value) {
            try {
                const lyr = map.getLayer(id); if (!lyr) return;
                const prop = opacityPropForType(lyr.type);
                if (prop) map.setPaintProperty(id, prop, value);
                if (lyr.type === 'symbol') { try { map.setPaintProperty(id, 'text-opacity', value); } catch { } }
            } catch { }
        }
        function setVisible(id, show) {
            try { map.setLayoutProperty(id, 'visibility', show ? 'visible' : 'none'); } catch { }
            if (show) setLayerOpacity(id, currentOpacity); // guard against 0 opacity in Studio
        }

        // Build year dots
        function buildYearDots(years, current) {
            yearDots.innerHTML = '';
            const n = years.length;
            years.forEach((y, i) => {
                const pct = n === 1 ? 0 : (i / (n - 1)) * 100;
                const dot = document.createElement('button');
                dot.type = 'button';
                dot.className = 'year-dot';
                dot.style.left = pct + '%';
                dot.setAttribute('aria-label', 'Select year ' + y);
                dot.dataset.year = y;

                const lbl = document.createElement('div');
                lbl.className = 'year-dot-label';
                lbl.style.left = pct + '%';
                lbl.textContent = String(y);

                dot.addEventListener('click', () => setYear(y));
                dot.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); setYear(y); }
                });

                yearDots.appendChild(dot);
                yearDots.appendChild(lbl);
            });
            setActiveDot(current);
        }
        function setActiveDot(y) {
            [...yearDots.querySelectorAll('.year-dot')].forEach(el => {
                el.classList.toggle('active', Number(el.dataset.year) === y);
            });
        }

        // Main
        map.on('load', () => {
            const styleLayers = map.getStyle()?.layers || [];
            const yearLayers = {};
            let total = 0;

            YEARS.forEach(y => {
                const re = new RegExp(`(^|[^0-9])${y}([^0-9]|$)`);
                const ids = styleLayers.filter(l => re.test(l.id)).map(l => l.id);
                yearLayers[y] = ids;
                total += ids.length;
                ids.forEach(id => setVisible(id, false));
            });

            // Choose newest available as default
            const availableYears = YEARS.filter(y => (yearLayers[y] || []).length);
            if (availableYears.length) {
                selectedYear = Math.max(...availableYears);
                setYear(selectedYear, false);
            } else {
                status.textContent = 'No year layers found. Ensure IDs include 2021–2025 and republish.';
            }
            status.textContent = `Found ${total} year-tagged layer(s).`;

            // Build dots + wire slider
            buildYearDots(YEARS, selectedYear);
            yearSlider.min = String(Math.min(...YEARS));
            yearSlider.max = String(Math.max(...YEARS));
            yearSlider.step = '1';
            yearSlider.value = String(selectedYear);
            yearVal.textContent = String(selectedYear);
            yearLabel.textContent = String(selectedYear);

            yearSlider.addEventListener('input', () => setYear(Number(yearSlider.value)));

            // Opacity slider
            opSlider.addEventListener('input', () => {
                currentOpacity = Number(opSlider.value) / 100;
                opVal.textContent = opSlider.value + '%';
                (yearLayers[selectedYear] || []).forEach(id => setLayerOpacity(id, currentOpacity));
            });

            // Click popup
            const popup = new mapboxgl.Popup({ closeButton: true, closeOnClick: true, maxWidth: '320px' });
            const CLASS_TEXT = ['(no value)', 'Low', 'Moderate', 'High', 'Very High'];
            const toLabel = v => {
                if (v == null || v === '') return '(no value)';
                const n = Number(v);
                if (!Number.isNaN(n)) return CLASS_TEXT[n] || String(v);
                const s = String(v).toLowerCase();
                if (s.includes('very')) return 'Very High';
                if (s.includes('high')) return 'High';
                if (s.includes('mod')) return 'Moderate';
                if (s.includes('low')) return 'Low';
                return String(v);
            };
            const badgeClass = l => {
                const s = String(l).toLowerCase();
                if (s.includes('very')) return 'badge b-vhigh';
                if (s.includes('high')) return 'badge b-high';
                if (s.includes('mod')) return 'badge b-mod';
                if (s.includes('low')) return 'badge b-low';
                return 'badge';
            };

            map.on('click', e => {
                const ids = (yearLayers[selectedYear] || []).filter(id => {
                    return map.getLayoutProperty(id, 'visibility') !== 'none';
                });
                if (!ids.length) return;
                const feats = map.queryRenderedFeatures(e.point, { layers: ids });
                if (!feats.length) return;

                const f = feats[feats.length - 1];
                const p = f.properties || {};
                const val = p.magnitude || p.hazard_cls || p.class || '';
                const lbl = toLabel(val);
                popup.setLngLat(e.lngLat).setHTML(
                    `<div class="popup"><div class="h">Flood Hazard — ${selectedYear}</div>
           <div class="kv"><div>Class</div><div><span class="${badgeClass(lbl)}">${lbl}</span></div></div></div>`
                ).addTo(map);
            });

            // helper to switch year
            function setYear(y, syncSlider = true) {
                YEARS.forEach(yy => (yearLayers[yy] || []).forEach(id => setVisible(id, false)));
                (yearLayers[y] || []).forEach(id => setVisible(id, true));
                selectedYear = y;
                if (syncSlider) yearSlider.value = String(y);
                yearVal.textContent = String(y);
                yearLabel.textContent = String(y);
                setActiveDot(y);
            }
            // expose for dot clicks
            window.setYear = setYear;
        });
    </script>
</body>

</html>
